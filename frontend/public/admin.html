<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de SHIDOG</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
    body { font-family: Arial; margin: 20px; background: #ffffff; }
    h1 { display: inline-block; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ffffff; }
    th { background: #007bff; color: white; }
    .delete-btn, .schedule-btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; }
    .delete-btn { background: red; color: white; }
    .schedule-btn { background: green; color: white; }
    #calendar { max-width: 800px; margin: 20px auto; background: white; padding: 10px; border-radius: 10px; }
    #calendarModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 9999; }

        /* Estilos generales del calendario */
#calendar {
    max-width: 50%px;
    margin: 20px auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.421);
    overflow: hidden;
}

/* Ajustar el ancho del contenedor del calendario */
#calendarContainer {
    width: 100%;
    max-width: 500px; /* Asegura que el calendario sea m√°s ancho */
    margin: 0 auto;
    overflow-x: auto; /* Permite desplazamiento horizontal si es necesario */
}

/* Asegurar que las columnas de los d√≠as tengan suficiente espacio */
.fc-daygrid-day {
    min-width: 100px; /* Ajusta seg√∫n sea necesario */
}



/* Ajustar tama√±o del t√≠tulo y botones de navegaci√≥n */
.fc-toolbar-title {
    font-size: 20px !important;
    font-weight: bold;
}

.fc-col-header-cell-cushion{
    color: #ffffff;
    text-decoration: none;

}

.fc-button {
    background-color: #007bff !important;
    border: none !important;
    color: white !important;
    padding: 6px 12px !important;
    border-radius: 5px !important;
}

.fc-button:hover {
    background-color: #0056b3 !important;
}

/* Ajustar tama√±o de los d√≠as en la vista de mes */
.fc-daygrid-day-number {
    font-size: 14px !important;
    font-weight: bold;
}

/* Asegurar que los eventos no ocupen demasiado espacio */
.fc-event {
    font-size: 12px !important;
    padding: 2px 5px !important;
    border-radius: 5px !important;
    background: #28a745 !important;
    color: white !important;
    text-align: center;
}

     /* Cambiar color del d√≠a actual en el calendario */
.fc-day-today {
    background-color: #aed1f1 !important;  /* fondo amarillo claro */
    border: 2px solid #007bff !important;  /* borde dorado */
}

  /* Opcional: cambiar color del n√∫mero del d√≠a */
.fc-day-today .fc-daygrid-day-number {
    color: #000274;
    font-weight: bold;
}

/* D√≠a con citas */
.dia-con-cita {
    background-color: #e3f2fd !important; /* Azul claro */
    border: 2px solid #90caf9 !important;
}

/* Evento por tipo de servicio */
.fc-event.adiestramiento {
    background-color: #007bff !important;
    border-color: #007bff !important;
}
.fc-event.modificacion {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
}
.fc-event.paseo {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
}
.fc-event.guarderia {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
}


    </style>
</head>
<body>

<h1>Mensajes de Contacto</h1>
<button onclick="toggleCalendario()" style="margin-left: 20px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
    üìÖ Ver Calendario
</button>


<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Email</th>
        <th>Servicio</th>
        <th>Mensaje</th>
        <th>Fecha</th>
        <th>Estado</th>
        <th>Comentario</th>
        <th>Agendar</th>
        <th>Eliminar</th>
    </tr>
    </thead>
    <tbody id="tabla-mensajes"></tbody>
</table>

<!-- CALENDARIO -->
<div id="calendarContainer" style="display: none; text-align: center;">
    <h2>üìÖ Calendario de Citas</h2>
    <div id="calendar"></div>
</div>


<!-- MODAL DE CITA -->
<div id="calendarModal">
    <h2>Agendar Cita</h2>
    <p id="appointment-info"></p>
    <input type="datetime-local" id="appointment-date">
    <br><br>
    <button onclick="guardarCita()">Guardar</button>
    <button onclick="cerrarCalendario()">Cancelar</button>
</div>

<script>
let citaActual = {};

function cargarMensajes() {
    fetch("http://localhost:5000/api/contacto")
    .then(res => res.json())
    .then(data => {
        const tbody = document.getElementById("tabla-mensajes");
        tbody.innerHTML = "";
        data.forEach(msg => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${msg.id}</td>
            <td>${msg.nombre}</td>
            <td>${msg.email}</td>
            <td>${msg.servicio}</td>
            <td>${msg.mensaje}</td>
            <td>${new Date(msg.fecha).toLocaleString()}</td>
            <td>
            <select onchange="actualizarEstado(${msg.id}, this.value)">
                <option ${msg.estado === "Pendiente" ? "selected" : ""}>Pendiente</option>
                <option ${msg.estado === "En proceso" ? "selected" : ""}>En proceso</option>
                <option ${msg.estado === "Completado" ? "selected" : ""}>Completado</option>
                <option ${msg.estado === "Cancelado" ? "selected" : ""}>Cancelado</option>
            </select>
            </td>
            <td><input value="${msg.comentario || ''}" onblur="actualizarComentario(${msg.id}, this.value)" /></td>
            <td><button class="schedule-btn" onclick="abrirCalendario(${msg.id}, '${msg.nombre}', '${msg.email}', '${msg.servicio}')">üìÖ</button></td>
            <td><button class="delete-btn" onclick="eliminarMensaje(${msg.id})">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(row);
        });
    });
}

function actualizarEstado(id, estado) {
    fetch(`http://localhost:5000/api/contacto/${id}/estado`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ estado })
    });
}

function actualizarComentario(id, comentario) {
    fetch(`http://localhost:5000/api/contacto/${id}/comentario`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ comentario })
    });
}

function eliminarMensaje(id) {
    if (confirm("¬øEliminar este mensaje?")) {
    fetch(`http://localhost:5000/api/contacto/${id}`, { method: "DELETE" })
        .then(() => cargarMensajes());
    }
}

function toggleCalendario() {
    const calendarContainer = document.getElementById("calendarContainer");

    if (calendarContainer.style.display === "none") {
        calendarContainer.style.display = "block";

        // üîπ Esperar 100ms y redibujar el calendario para que se ajuste correctamente
        setTimeout(() => {
            calendar.updateSize();
        }, 100);
    } else {
        calendarContainer.style.display = "none";
    }
}


function abrirCalendario(id, nombre, email, servicio) {
    citaActual = { id_contacto: id, nombre, email, servicio };
    document.getElementById("appointment-info").innerText = `${nombre} - ${servicio}`;
    document.getElementById("calendarModal").style.display = "block";
}

function cerrarCalendario() {
    document.getElementById("calendarModal").style.display = "none";
}

function guardarCita() {
    const fecha = document.getElementById("appointment-date").value;
    if (!fecha) return alert("Selecciona una fecha y hora");

    fetch("http://localhost:5000/api/contacto/citas", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...citaActual, fecha })
    })
    .then(res => res.json())
    .then(() => {
    alert("Cita guardada");
    cerrarCalendario();
    location.reload();
    });
}

document.addEventListener("DOMContentLoaded", () => {
    cargarMensajes();

    const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
        initialView: "dayGridMonth",
        locale: "es",
        headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek"
        },
        events: async (info, successCallback) => {
            const res = await fetch("http://localhost:5000/api/contacto/citas");
            const citas = await res.json();

            const colores = {
                "Adiestramiento b√°sico": "adiestramiento",
                "Modificaci√≥n de conducta": "modificacion",
                "Paseo y socializaci√≥n": "paseo",
                "Guarder√≠a canina": "guarderia"
            };

            const eventos = citas.map(c => ({
                title: c.servicio,
                start: c.fecha,
                allDay: false,
                classNames: [colores[c.servicio] || "default"],
                extendedProps: {
                    nombre: c.nombre,
                    email: c.email,
                    mensaje: c.mensaje
                }
            }));

            successCallback(eventos);
        },
        eventDidMount: function(info) {
            // Tooltip con Bootstrap
            new bootstrap.Tooltip(info.el, {
                title: `üë§ ${info.event.extendedProps.nombre}\n‚úâÔ∏è ${info.event.extendedProps.email}\nüìù ${info.event.extendedProps.mensaje}`,
                placement: "top",
                trigger: "hover",
                container: "body"
            });

            // Resaltar el d√≠a de la cita
            const fecha = info.event.startStr.slice(0, 10); // YYYY-MM-DD
            const celda = document.querySelector(`.fc-daygrid-day[data-date="${fecha}"]`);
            if (celda) {
                celda.classList.add("dia-con-cita");
            }
        }
    });

    calendar.render();
});

</script>
</body>
</html>
